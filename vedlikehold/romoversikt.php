<?php/** * Romoversikt * * Denne siden gir en grafisk ukesfremvisning for et angitt rom på hvorvidt * rommet er booket til forskjellige tidspunkt. Brukeren får selv velge hvilken * uke som er ønsket å se bestillinger for. Når uke og rom er valgt så får man tilbake * en komplett ukesoversikt for den angitte uken. Her blir bestilte tidsrom fremvist med * en rød firkant, mens ledige tidsrom blir fremvist med grønne. * * PHP version 5 * * LICENSE: This source file is subject to version 3.01 of the PHP license * that is available through the world-wide-web at the following URI: * http://www.php.net/license/3_01.txt.  If you did not receive a copy of * the PHP License and are unable to obtain it through the web, please * send a note to license@php.net so we can mail you a copy immediately. * * @author		Original Author <andersborglarsen@gmail.com> * @author		Original Author <haavard@ringshaug.net> * @author		Original Author <oyvind.gautestad@gmail.com> * @author		Original Author <linda.fermann@gmail.com> * @copyright 	2013-2018 * @license		http://www.php.net/license/3_01.txt * @link		http://student.hive.no/web10007/1 * */$title = 'Romoversikt - roomEdit';include("../includes/headerVedlikehold.php");		// INKLUDERER STARTEN AV DESIGNETcheckLogin();									// SJEKKER OM EN BRUKER ER LOGGET INNcheckAdmin();									// SJEKKER OM EN BRUKER ER ADMIN$currentWeek = date("Y, W");						// SETTER NÅVÆRENDE UKE OG ÅR FOR Å FYLLE UT I SKJEMAET?><form method="post" action="" name="roomOverview" id="roomOverview">	<fieldset>		<legend>Romoversikt</legend>		<label for="date" class="clearfloat">Uke</label> <input type="week"			name="week" value="<?php echo $currentWeek; ?>"> <label for="rom" class="clearfloat">Rom</label> <select			name="room">			<?php 			// HENTER UT ALLE GRUPPEROM SOM BLIR FUNNET I DATABASEN			$userRef	=	$_SESSION['userRef'];						// HENTER BRUKER-REF FRA SESSION OG LAGRER I VARIABEL			listRooms($userRef);										// FUNKSJONSKALL PÅ BRUKERREFF			?>			<input type="submit" value="Oversikt" id="romOversiktKnapp"			name="romOversiktKnapp" tabindex="7" />		</fieldset></form><?php $romOversiktKnapp 	= 	$_POST["romOversiktKnapp"];						// LAGER ROMOVERSIKTSKNAPPif($romOversiktKnapp) {													// VENTER PÅ AT OVERSIKTSKNAPPEN SKAL BLI TRYKKET	// SETTER VARIABLENE SOM BRUKES FOR Å REGNE UT LASTETIDEN AV SIDEN	$time = microtime();					// LAGRER CURRENT UNIX TIMESTAMP PÅ MIKROSEKUNDET	$time = explode(' ', $time);			// EKSPLODERER TIME VARIABELEN PÅ MELLOMROM	$time = $time[1] + $time[0];			// SLÅR SAMMEN TO KOLONNER I TIME TABELLEN	$start = $time;							// SETTER START VARIABELEN LIK TIME VARIABELEN	// SETTER VARIABLENE SOM BRUKES FOR Å BYGGE OPP DET GRAFISKE SNITTET	$room 		= 	$_POST["room"];			// HENTER INN ROMMET VARIABELEN FRA SKJEMAET	$roomType	=	getRoomType($room);		// VARIABEL SOM KJØRER ET FUNKSJONSKALL FOR Å FINNE HVORDAN TYPE ET ROM ER	$tabell		=	array(array());			// LAGER EN TO-DIMMENSJONAL TABELL	$week		=	substr($_POST["week"],6,8);		// LAGRER HVILKEN UKE DET ER BASERT PÅ UKEN VALGT I SKJEMAET	$year		= 	substr($_POST["week"],0,4);		// LAGRER HVILKET ÅR DET ER BASERT PÅ VALG I SKJEMAET	$weeklyDays	=	array();				// LAGER ET EN-DIMMENSJONAL TABELL FOR Å LAGRE UKEDAGENE(ALDRI OVER 7 DAGER)	// TIMESTAMP VARIABLER SOM BRUKES FOR Å REGNE UT DATOEN TIL DEN FØRSTE MANDAGEN I VALGT UKE	$timestamp				= mktime( 0, 0, 0, 1, 1,  $year ) + ( $week * 7 * 24 * 60 * 60 );	// LAGRER EN TIMESTAMP PÅ ÅR OG DAG.	$timestamp_for_monday 	= mktime( 0, 0, 0, 1, 1,  $year ) + ((7+1-(date( 'N', mktime( 0, 0, 0, 1, 1,  $year ) )))*86400) + ($week-2)*7*86400 + 1 ;	// FINNER UT TIMESTAMP FOR MANDAG OG LAGRER DETTE	$date_for_monday 		= date( 'Y-m-d', $timestamp_for_monday );	// LAGRER ÅR-MND-DAG TIL TIMESTAMP FOR MANDAG	$month					= substr($date_for_monday,5,-3);			// LAGRER HVILKEN MND DET ER	$days_in_month			= cal_days_in_month(0, date( 'm', $timestamp_for_monday ), $year); // KALKULERER HVOR MANGE DAGER DET ER I DEN ANGITTE MND		$firstDayNextMonth = date('Y-m-d', mktime(0, 0, 0, date('m')+1, 1, date('Y')));			// SJEKKER OM BRUKEREN HAR VALGT EN UKE, HVIS IKKE SÅ RETURNERES FEILMELDING	if(!$week) {						// SJEKKER OM BRUKEREN HAR VALGT EN UKE		print ("Du må velge en uke");	// SKRIVER UT EILMELDING HVIS BRUKEREN IKKE HAR SATT EN UKE	} else {		$teller = 1;		for($i=0;$i<7;$i++){			// FOR-LØKKE SOM KJØRES 7 GANGER FOR Å SETTE DATOENE FOR EN ANGITT UKE			if(substr($date_for_monday,8,9) <= $days_in_month) { // SJEKKER HVOR MANGE DAGER DET ER I EN MND SÅ VI IKKER OVERGÅR  DETTE				$weeklyDays[$i] = $date_for_monday++;	// FYLLER UT WEEKLYDAYS TABELLEN MED DATOENE FRA MANDAG OG FREMOVER			}			else { 				$weeklyDays[$i] = $firstDayNextMonth++;			}							// STOPPER HVIS DET IKKE ER FLERE DAGER IGJEN I EN ANGITT MND		}		// HENTER UT KLOKKESLETT FRA DATABASEN FOR Å VITE HVILKE VARIABLER SOM BLIR BRUKT		connect();														// KOBLER TIL DATABASEN		$sqlSetning="SELECT TIME_FORMAT(Klokka, '%H:%i') FROM time;";	// SQL KALL		$sqlResultat=mysql_query($sqlSetning) or die ("ikke mulig å hente data fra databasen");	// LAGRER SQL KALLET I EN VARIABEL		$antallKolonner=mysql_num_rows($sqlResultat);					// LAGRER HVOR LANGT RESULTATET ER		disconnect();													// KOBLER FRA DATABASEN		// ALGORITMEN SOM FYLLER UT DET GRAFISKE SNITTET		$weekLength 	=	count($weeklyDays);							// FINNER UT HVOR LANG EN ANGITT UKE ER		$antallRader	=	$weekLength+1;								// SETTER VARIABEL FOR UKESLENGDE+1(FOR KLOKKESLETT)		$teller=0;														// LAGER EN TELLER FOR Å TELLE ANTALL KALL		for($i=0;$i<$antallRader;$i++){									// FOR-LØKKE SOM TELLER SEG NEDOVER ANTALL RADER			for($j=0;$j<$antallKolonner;$j++){							// FOR-LØKKE SOM TELLER SEG BORTOVER ANTALL KOLONNER				$rad=mysql_fetch_array($sqlResultat);					// HENTER UT EN RAD FRA SQL ARRAYET				if($i == 0) {											// LAGER FØRSTE RAD I TABELLEN, DENNE BESTÅR AV TIDSINTERVALLENE FRA DATABASEN					$tabell[0][$j] = $rad[0];							// FYLLER UT FØRSTE RADEN I TABELLEN MED KLOKKESLETT				} else {					if($j==0 ) {										// SJEKKER HVILKEN KOLONNE VI ER KOMMET TIL					} else {						$tabell[$i][$j] = isBooked($tabell[0][$j].":00", $tabell[0][$j+1].":01", $room, $weeklyDays[$teller-1]);	// SJEKKER OM EN POSISJON I TO-DIM-TABELLEN ER BOOKET ELLER IKKE MED ET FUNKSJONSKALL					}				}			}			$teller++;													// TELLER SEG OPPOVER MED +1 FOR Å VITE HVOR LANGT VI ER KOMMET		}		// BEGYNNER Å BYGGE SIDEN// 		print "<input type='button' id='printbutton' value='Print ut' onclick='window.print();' /> ";		print ("<h1> Romoversikt </h1>");								// SKRIVER UT STATISK TEKST PÅ SIDEN		print ("<h2> $room </h2> ");									// SKRIVER UT DYNAMISK TEKST PÅ SIDEN MED HVILKET ROM SOM ER VALGT		print ("<p> Uke: $week");										// SKRIVER UT DYNAMISK TEKST PÅ SIDEN MED HVILKEN UKE VI ER I		print ("<br /><br />"); 										// SKRIVER UT STATISK TEKST FOR Å LAGE TO BREAK LINJER FOR Å FÅ TO MELLOMROM		print "<button onclick='window.print();' />";		// THEAD, HODET PÅ TABELLEN SOM ER DET GRAFISKE SNITTET		for($i=0;$i<$weekLength;$i++){									// FOR-LØKKE SOM KJØRER SÅ LANGT SOM EN ANGITT UKE ER (0->7)			print ("<p class='dagsOversikt'>");							// SKRIVER UT STATISK KODE PÅ SIDEN			print norwegianWeekDayName(date('l',strtotime($weeklyDays[$i])));					// SKRIVER UT EN DATO STRENG BASERT PÅ WEEKLYDAYS TABELLEN			print (" $weeklyDays[$i] </p>");							// SKRIVER UT DYNAMISK TEKST PÅ SIDEN			print ("<table class='dagsOversikt'>");  					// STARTEN PÅ TABELLEN SOM SKAL VISES			print ("<thead>				<tr>				");														// STARTER THEAD PÅ SIDEN			for ($r=0;$r<$antallKolonner;$r++){						 	// FOR-LØKKE SOM KJØRER LIKE MANGE GANGER SOM ANTALL KOLONNER VI HAR				print("<th><div class='tidsOversikt'>");				// SKRIVER UT KODE PÅ SIDEN				echo $tabell[0][$r];									// SKRIVER UT EN ANGITT POSISJON I DEN TO-DIMMENSJONALE TABELLEN				print("</div></th>");									// SKRIVER UT KODE PÅ SIDEN			}print ("</tr>		</thead>");														// AVSLUTTER THEAD PÅ SIDEN// TBODY, KROPPEN TIL TABELLENprint ("<tbody>					<tr> ");											// STARTER TABELL BODYENfor ($r=0;$r<$antallKolonner;$r++){										// FOR-LØKKE SOM KJØRES LIKE MANGE GANGER SOM VI HAR ANTALL KOLONNER	print("<td><div class='verdier'>");									// SKRIVER UT KODE PÅ SIDEN	echo $tabell[$i+1][$r];												// SKRIVER UT EN ANGITT POSISJON I DEN TO-DIMMENSJONALE TABELLEN	print("</div></td>");												// SKRIVER UT KODE PÅ SIDEN}print ("</tr></tbody><br />");											// AVSLUTTER TBODY PÅ SIDENprint ("</table>");														// AVSLUTTER TABELLEN PÅ SIDEN	 			}		$time = microtime();											// SETTER NY MICROTIME		$time = explode(' ', $time);									// EKSPLODERER STRENGEN PÅ MELLOMROM		$time = $time[1] + $time[0];									// SLÅR SAMMEN TO KOLONNER		$finish = $time;												// SETTER SLUTTTID		$total_time = round(($finish - $start), 4);						// BEREGNER HVOR LANG TID SIDEN HAR BRUKT PÅ Å LASTE		echo "<p class='footer'> Page generated in <i>$total_time</i> seconds</p></button>";	// SKRIVER UT HVOR LANG TID SIDEN HAR BRUKT PÅ Å LASTE	}}include("../includes/footerVedlikehold.php");		// INKLUDERER SLUTTEN AV DESIGNET?>