<?php /** * Utføre søk i løsningen. Mulig å søke etter rom, brukere eller bestilling * * Romsøk: * 		Søk med romId, romnavn eller romtype * Brukersøk: * 		Søk med brukerId, brukernavn, e-post eller brukerreferanse * Reservasjonsøk: * 		Hvis valgboks "søk bestilling" er huket av er det mulig å * 		søke på bestilling med dato (kalender), romnavn, bookingreferanse eller bruker * * Det søkes først i room-tabell og hvis det ikke er treff søkes det i user og position. * Hvis sjekkboks "søk bestilling" er valgt søkes det i et view som inneholder data * fra reservation, user, position og room tabellene * * PHP version 5 * * LICENSE: This source file is subject to version 3.01 of the PHP license * that is available through the world-wide-web at the following URI: * http://www.php.net/license/3_01.txt.  If you did not receive a copy of * the PHP License and are unable to obtain it through the web, please * send a note to license@php.net so we can mail you a copy immediately. * * @author		Original Author <andersborglarsen@gmail.com> * @author		Original Author <haavard@ringshaug.net> * @author		Original Author <oyvind.gautestad@gmail.com> * @author		Original Author <linda.fermann@gmail.com> * @copyright 	2013-2018 * @license		http://www.php.net/license/3_01.txt * @link		http://student.hive.no/web10007/1 * */?><?php $title = 'Søk - roomEdit';include '../includes/headerVedlikehold.php';			// INKLUDERER HEADEREN TIL SIDENcheckLogin();											// SJEKKER OM EN BRUKER ER INNLOGGETcheckAdmin();											// SJEKKER OM EN BRUKER HAR ADMIN STATUS$userRef = $_SESSION['userRef'];						// HENTER UT USERREF FRA SESSION OG LAGRER I EN LOKAL VARIABEL?><h1>Utfør søk i løsningen</h1><fieldset>	<legend>Skriv inn søkedata</legend>	<?php 	$selectDate = phpCalendar($userRef); 					// FUNKSJOKALL TIL PHP KALENDEREN SOM SENDER INN USERREF OG LAGRER SVARET I EN LOKAL VARIABEL	$selectDate = $_POST["selectDate"];						// SETTER DATO FRA SKJEMAET	?>	<form class="" name="searchForm" id="searchForm" action=""		method="post">		<p>			Du har valgt dato:			<?php echo normalDate($selectDate); ?>		</p>		<input type="hidden" name="date" id="date"			value="<?php echo $selectDate; ?>" /> <label for="searchBox">Søketekst</label><input			type="text" name="searchBox" id="searchBox" placeholder=" søk "> <label			for="checkNoBooking">Søk bestilling</label><input type="checkbox"			name="checkNoBooking" id="checkNoBooking" value="noBooking"> <input			class="submit" type="submit" value="Søk" name="searchButton"			id="searchButton"> <input class="submit" type="submit"			onClick="document.location.reload(true)" value="Nullstill"			id="nullstill" name="nullstill">	</form></fieldset><?php /****************************** Søk ****************************************/$searchType		=	$_POST["searchType"];					// HENTER INN DATA FRA SKJEMAET$searchButton	=	$_POST["searchButton"];					// HENTER INN KNAPPEN FRA SKJEMAET$searchBox		=	$_POST["searchBox"];					// HENTER INN DATA FRA SKJEMAET$date			=	$_POST["date"];							// HENTER INN DATA FRA SKJEMAET$checkNoBooking	=	$_POST["checkNoBooking"];				// HENTER INN DATA FRA SKJEMAETif($searchButton){	connect();												// KOBLER TIL DATABASEN	// hvis sjekkboks "Uten booking" er markert. Søker først på romtabell	if(!$checkNoBooking){		$sql="SELECT RoomId, Name, Type		FROM room		WHERE RoomId LIKE '$searchBox%' OR		Name LIKE '$searchBox%' OR		Type LIKE '$searchBox%';";		$result = mysql_query($sql) or die ("ikke mulig å søke i databasen");	// KJØRER SQL SPØRRINGEN PÅ SERVER		$numRows = mysql_num_rows($result);										// HENTER UT ANTALL RADER I SQL ARRAYET		$col1="RomId";										// LAGRER LOKAL VARIABEL		$col2="Navn";										// LAGRER LOKAL VARIABEL		$col3="Type";										// LAGRER LOKAL VARIABEL		// hvis det ikke returneres noe rom, søkes det gjennom brukertabell		if($numRows == 0){			$sql="SELECT UserId, Username, Mail, Type, Admin, Ref_User			FROM user JOIN position			ON Position_Id = PositionId			WHERE UserId LIKE '$searchBox%' OR			Username LIKE '$searchBox%' OR			Mail LIKE '$searchBox%' OR			Ref_User LIKE '$searchBox%';";			$result = mysql_query($sql) or die ("ikke mulig å søke i databasen");	// KJØRER SQL SPØRRINGEN PÅ SERVER			$numRows2 = mysql_num_rows($result);										// HENTER UT ANTALL RADER I SQL ARRAYET							if($numRows2 == 0) {				echo "Ingen match for ditt søk";			} else {				// 			$col1="Id";											// LAGRER LOKAL VARIABEL				$col2="Brukernavn";									// LAGRER LOKAL VARIABEL				$col3="Epost";										// LAGRER LOKAL VARIABEL				$col4="Brukergruppe";								// LAGRER LOKAL VARIABEL				$col5="Admin";										// LAGRER LOKAL VARIABEL				$col6="Brukeref";									// LAGRER LOKAL VARIABEL				echo "				<table class='standard_table'>				<thead class='standard_table_header'>				<tr>";				// 						<th>$col1</th>				echo "				<th>$col2</th>				<th>$col3</th>				<th>$col4</th>				<th>$col5</th>				<th>$col6</th>				</tr>				</thead>				<tbody>				";				for($t=1; $t<=$numRows2; $t++){							// FOR-LØKKE SOM KJØRER LIKE MANGE GANGER SOM VI HAR RADER I ARRAYET					$row=mysql_fetch_array($result);					// HENTER UT SQL ARRAYET					echo "					<tr>";					// 			<td class='standard_table_data'>$row[0]</td>					echo "<td class='standard_table_data'>$row[1]</td>					<td class='standard_table_data'>$row[2]</td>					<td class='standard_table_data'>$row[3]</td>					<td class='standard_table_data'>";					echo isAdminString($row[4]);					echo "</td>					<td class='standard_table_data'>$row[5]</td>					<td class='standard_table_data'>$row[6]</td>																	<form method='post' action='endre-bruker.php' name='editUser' id='editUser'>					<td><input type='hidden' value='$row[0]' name='userId' id='UserId'></td>					<td><input type='submit' value='Endre' name='modifySubmit' id='modifySubmit'>					</form>					<form method='post' action='vis-brukere.php' name='deleteUser' id='deleteUser' onSubmit='return confirmDelete()'>					<td><input type='hidden' value='$row[5]' name='ref_users' id='ref_users'></td>					<td><input type='hidden' value='$row[1]' name='username' id='username'></td>					<td><input type='submit' value='Slett' name='deleteSubmit' id='deleteSubmit'></td>					</form>					<form method='post' action='nytt-passord.php' name='passwordchange' id='passwordchange'>					<td><input type='hidden' value='$row[0]' name='userId' id='userId'></td>					<td><input type='submit' value='Endre Passord' name='newpassword' id='newpassword'></td>					</form>					</tr>					";				}			}		} else {			echo "	 		<table class='standard_table'>				<thead class='standard_table_header'>				<tr>";			// 						<th>$col1</th>			echo "			<th>$col2</th>			<th>$col3</th>			<th>$col4</th>			<th>$col5</th>			<th>$col6</th>			</tr>			</thead>			<tbody>			";			for($t=1; $t<=$numRows; $t++){							// FOR-LØKKE SOM KJØRER LIKE MANGE GANGER SOM VI HAR RADER I ARRAYET				$row=mysql_fetch_array($result);					// HENTER UT SQL ARRAYET				echo "					<tr>";				// 			<td class='standard_table_data'>$row[0]</td>				echo "<td class='standard_table_data'>$row[1]</td>				<td class='standard_table_data'>$row[2]</td>				<form method='post' action='endre-rom.php' name='modRoomForm' id='modRoomForm'>				<td class='standard_table_data'><input type='hidden' value='$row[0]' name='room_id' id='room_id'></td>				<td class='standard_table_data'><input type='submit' value='Endre' name='modifySubmit' id='modifySubmit'>				</form>				<form method='post' action='vis-rom.php' name='deleteRoomForm' id='deleteRoomForm' onSubmit='return confirmDelete()'>				<td class='standard_table_data'><input type='hidden' value='$row[0]' name='room_id' id='room_id'></td>				<td class='standard_table_data'><input type='submit' value='Slette' name='deleteSubmit' id='deleteSubmit'></td>				</form>									</tr>				";			}		}	} else {		if( $date ){			$searchDate="Dato='$date'";			if( $searchBox ){				$operator="AND";			}		}		if( $searchBox ){			$searchBoxIsset="			RoomName LIKE '$searchBox%' OR			BookingRef LIKE '$searchBox%' OR			Username LIKE '$searchBox%' ";		}		if ( $searchBox || $date ){			$clause = "WHERE";		}		$sql="SELECT *		FROM search		$clause $searchDate $operator $searchBoxIsset		ORDER BY Dato DESC, StartTime ASC;";		$result = mysql_query($sql) or die ("ikke mulig å søke i databasen");	// KJØRER SQL SPØRRINGEN PÅ SERVER		$numRows = mysql_num_rows($result);										// HENTER UT ANTALL RADER I SQL ARRAYET		echo "							<table class='standard_table'>							<thead class='standard_table_header'>							<tr>							<th>Rom</th>							<th>Romtype</th>							<th>Dato</th>							<th>BookingRef</th>							<th>Starttid</th>							<th>Sluttid</th>							<th>Brukernavn</th>							<th>Stilling</th>							<th>E-post</th>							</tr>							</thead>							<tbody>							";		for($t=1; $t<=$numRows; $t++){												// FOR-LØKKE SOM KJØRER LIKE MANGE GANGER SOM VI HAR RADER I ARRAYET		$row=mysql_fetch_array($result);										// HENTER UT SQL ARRAYET		$position 	= $row[0];		$username 	= $row[1];		$mail 		= $row[2];		$startTime 	= substr($row[3],0,5);		$endTime	= substr($row[4],0,5);		$date 		= normalDate($row[5]);		$bookingRef = $row[6];		$roomName 	= $row[7];		$roomType 	= $row[8];		echo "		<tr>		<td class='standard_table_data'>$roomName</td>		<td class='standard_table_data'>$roomType</td>		<td class='standard_table_data'>$date</td>		<td class='standard_table_data'>$bookingRef</td>		<td class='standard_table_data'>$startTime</td>		<td class='standard_table_data'>$endTime</td>		<td class='standard_table_data'>$username</td>		<td class='standard_table_data'>$position</td>		<td class='standard_table_data'>$mail</td>				<form class='' name='editBooking' id='editBooking' action='endre-bestilling.php' method='post'>		<td class='standard_table_data'><input type='text' hidden='true' value='$bookingRef' name='ref_booking' id='ref_booking'></td>		<td class='standard_table_data'><input type='text' hidden='true' value='$username' name='username' id='username'></td>		<td class='standard_table_data'><input type='submit' value='Endre' name='editBookingSubmit' id='editBookingSubmit'></td>		</form>		<form class='' name='deleteBooking' name='deleteBooking' action='' method='post' onSubmit='return confirmDelete()'>		<td class='standard_table_data'><input type='text' hidden='true' value='$bookingRef' name='ref_booking' id='ref_booking'> </td>		<td class='standard_table_data'><input type='submit' value='Slett' name='deleteBookingSubmit' id='deleteBookingSubmit'></td>		</form>				</tr>		";		}	}	disconnect();													// KOBLER FRA DATANBASEN}?></tbody><tfoot>	<tr>		<th></th>		<th></th>		<th></th>		<th></th>		<th></th>		<th></th>		<th></th>		<th></th>		<th></th>	</tr></tfoot></table><?php include '../includes/footerVedlikehold.php';						// INKLUDERER FOOTEREN?>