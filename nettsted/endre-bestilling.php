<?php/** * Endre valgt bestilling * *Brukeren har valgt en bestilling i bestillingsoversikten som ønskes endret. *Kan kun endre tidsrom, da man må slette bestilling dersom annen dato *eller annet rom ønskes bestilt. *Er tiltenkt situasjoner hvor man ønsker å endre starttidspunkt eller  *sluttidspunkt. * * * * PHP version 5 * * LICENSE: This source file is subject to version 3.01 of the PHP license * that is available through the world-wide-web at the following URI: * http://www.php.net/license/3_01.txt.  If you did not receive a copy of * the PHP License and are unable to obtain it through the web, please * send a note to license@php.net so we can mail you a copy immediately. * * @author		Original Author <andersborglarsen@gmail.com> * @author		Original Author <haavard@ringshaug.net> * @author		Original Author <oyvind.gautestad@gmail.com> * @author		Original Author <linda.fermann@gmail.com> * @copyright 	2013-2018 * @license		http://www.php.net/license/3_01.txt * @link		http://student.hive.no/web10007/1 * */$title = 'Endre bestilling';								//SETTER TITTEL PÅ SIDEN I BROWSERFANEinclude("../includes/headerNettsted.php");					//INKLUDERER HEADEREN PÅ NETTSTEDETcheckLogin();												//SJEKKER OM BRUKER ER LOGGET INN?><?php $ref_booking=$_POST["ref_booking"];							//LAGER REF_BOOKINGKNAPP OG INNEHAR BESTILLINGSREFERANSEN HENTET FRA DEN BESTILLINGEN MAN ØNSKER ENDRETconnect();													//KOBLER TIL DATABASEN$sql="SELECT Dato,Start_Time,End_Time,Name,Type,Ref_Booking		FROM Booking AS B INNER JOIN room AS R		ON B.Room_ID = R.RoomId		WHERE B.Ref_Booking='$ref_booking';";				//SQL-SPØRRING SOM HENTER NØDVENDIG INFORMASJON OM DEN AKTUELLE BESTILLINGEN $result = mysql_query($sql) or die ("Ikke mulig å hente bestillinger fra databasen");		//KJØRER SPØRRINGEN MOT DATABASEN OG LAGRER RESULTATET I VARIABEL$row= mysql_fetch_array($result);							//HVER RAD TILORDNES ETT SETT MED VERDIER I FORM AV ARRAYdisconnect();												//KOBLER FRA DATABASEN$dato=$row[0];												//FØRSTE VERDI I HVER RAD LAGRES I VARIABEL$start_time=$row[1];										//ANDRE VERDI I HVER RAD LAGRES I VARIABEL$end_time=$row[2];											//TREDJE VERDI I HVER RAD LAGRES I VARIABEL$name=$row[3];												//FJERDE VERDI I HVER RAD LAGRES I VARIABEL$type=$row[4];												//FEMTE VERDI I HVER RAD LAGRES I VARIABEL$ref_booking=$row[5];										//SJETTE VERDI I HVER RAD LAGRES I VARIABEL$bookedStart=explode(":", $start_time);						//EKS. STARTTIDSPUNKT 12:00:01 LØSES OPP MED : SOM SKILLETEGN$bookedStartHour = $bookedStart[0];							//FØRSTE VERDI (EKS 12) TILORNES EN VARIABEL$bookedStartMinute = $bookedStart[1];						//ANDRE VERDI (EKS. 00) TILORDNES EN VARIABEL (SEKUNDER TRENGER VI IKKE, SOM ER DEN TREDJE VERDIEN)$bookedEnd=explode(":", $end_time);							//EKS. SLUTTIDSPUNKT 14:00:00 LØSES OPP MED : SOM SKILLETEGN$bookedEndHour = $bookedEnd[0];								//FØRSTE VERDI (EKS 14) TILORNES EN VARIABEL$bookedEndMinute = $bookedEnd[1];							//ANDRE VERDI (EKS. 00) TILORDNES EN VARIABEL (SEKUNDER TRENGER VI IKKE, SOM ER DEN TREDJE VERDIEN)$bookedMinutesChange = ($bookedEndHour-$bookedStartHour) * 60 + $bookedEndMinute - $bookedEndMinute; // beregner antall minutter for reservasjon som skal endres (brukes som inn-parameter i valideringsfunksjon checkUserLeftHours())//Skriver ut HTML-skjema hvor dato og romnummer vises. normalTime() -funksjon viser start- og sluttidspunkt uten sekunder (se forklaring i funksjonsfil)echo("<form class='' name='editBooking' id='editBooking' action='' method='post'>	<fieldset>		<legend>Endre bestilling</legend>				<p>Dato: <strong>$dato</strong></p>				<p>RomNr: <strong>$name</strong></p>				<p>Opprinnelig bestilt tidsrom er fra " . normalTime($start_time) . " til " . normalTime($end_time) . ". Endre tidspunkt under.</p> 				<label for='startTimeHours' class='clearfloat'>Fra kl</label>		<select name='startTimeHours'>");			$timer = array();																// LAGER ET ARRAY FOR TIMER							connect();																		//KOBLER TIL DATABASEN			$sql="SELECT SUBSTRING(Klokka,1,2) as Timer FROM time GROUP BY Timer HAVING COUNT(*);";	// HENTER UT TIMER FRA DATABASEN			$result=mysql_query($sql) or die ("ikke mulig å hente timer fra databasen");	//KJØRER SPØRRINGEN MOT DATABASEN OG LAGRER RESULTATET I VARIABEL			$timerLength=mysql_num_rows($result);											// VARIABEL SOM SIER HVOR MANGE TIMER (RADER) ARRAYET ER			disconnect();																	// KOBLER FRA DATABASEN						for($i=0;$i<$timerLength;$i++) {												// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM TIMER TABELLEN HAR I LENGDE				$rad=mysql_fetch_array($result);											// LAGER VARIABEL $RAD SOM INNEHOLDER HELE ARRAYET				$timer[$i] = $rad[0];														// TILORDNER ALT FRA $RAD ARRAYET TIL TIME ARRAYET				echo "<option value='$rad[0]' "; if($rad[0] == $bookedStartHour) { echo "selected"; } echo ">$rad[0]</option>";							// SKRIVER DEN SPESIFIKKE KOLONNEN FRA $RAD ARRAYET OG PRINTER SELECTED HVIS BOOKEDSTARTHOUR = RAD VARIABEL			}		echo ("</select> 						<select name='startTimeMinutes'>");			$minutter = array();															// LAGER ET ARRAY FOR MINUTTER						connect();																		//KOBLER TIL DATABASEN			$sql="SELECT SUBSTRING(Klokka,4,2) as Minutter FROM time GROUP BY Minutter HAVING COUNT(*) > 1;";	// HENTER UT MINUTTER FRA DATABASEN			$result=mysql_query($sql) or die ("ikke mulig å hente minutter fra databasen");	//KJØRER SPØRRINGEN MOT DATABASEN OG LAGRER RESULTATET I VARIABEL			$minLength=mysql_num_rows($result);												// VARIABEL SOM SIER HVOR MANGE MINUTTER (RADER) ARRAYET ER			disconnect();																	//KOBLER FRA DATABASEN									for($i=0;$i<$minLength;$i++) {													// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM MINUTTER TABELLEN HAR I LENGDE				$rad=mysql_fetch_array($result);											// LAGER VARIABEL $RAD SOM INNEHOLDER HELE ARRAYET				$minutter[$i] = $rad[0];													// TILORDNER ALT FRA $RAD ARRAYET TIL MINUTT ARRAYET				echo "<option value='$rad[0]' "; if($rad[0] == $bookedStartMinute) { echo "selected"; } echo ">$rad[0]</option>";							// SKRIVER DEN SPESIFIKKE KOLONNEN FRA $RAD ARRAYET			}		echo ("</select> 				<label for='endTimeHours' class='clearfloat'>Til kl</label> 		<select name='endTimeHours'>");						for($i=0;$i<$timerLength;$i++) {												// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM TIMETABELLEN ER I LENGDE				echo "<option value='$timer[$i]' "; if($timer[$i] == $bookedEndHour) { echo "selected"; } echo ">$timer[$i]</option>";						// SKRIVER DEN SPESIFIKKE KOLONNEN I TIMETABELLEN			}		echo ("</select> 					<select name='endTimeMinutes'>");					for($i=0;$i<$minLength;$i++) {													// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM MINUTTTABELLEN ER I LENGDE				echo "<option value='$minutter[$i]' "; if($minutter[$i] == $bookedEndMinute) { echo "selected"; } echo ">$minutter[$i]</option>";				// SKRIVER DEN SPESIFIKKE KOLONNEN I MINUTT-TABELLEN			}		echo ("</select> 				<input type='hidden' value='$ref_booking' name=ref_booking id=ref_booking>		<input type='hidden' value='$date' name=date id=date>		<input type='hidden' value='$name' name=name id=name>				<input type='hidden' value='$bookedMinutesChange' name=bookedMinutesChange id=bookedMinutesChange>				<input type='submit' value='Endre' name='editBookingConfirm' id='editBookingConfirm'	</fieldset></form>");		echo ("		<form method='post' action='index.php'>		<input type='submit' value='Avbryt' id='back' name='back'>		</form>		");																					//AVBRYTER ENDRING OG DIRIGERER TILBAKE$editBookingConfirm = $_POST["editBookingConfirm"];											//LAGER ENDRE-KNAPPif($editBookingConfirm) {																	//LYTTER TIL OM ENDRE-KNAPPEN BLIR TRYKKET	$date			= 	$_POST["date"];														// HENTER INN DATO VARIABEL FRA SKJEMAET	$startTimeClean = 	$_POST["startTimeHours"].":".$_POST["startTimeMinutes"];			// HENTER INN CLEAN STARTTID FRA SKJEMAET(UTEN SEKUNDER)	$endTimeClean	=	$_POST["endTimeHours"].":".$_POST["endTimeMinutes"];				// HENTER INN CLEAN SLUTT-TID FRA SKJEMAET(UTEN SEKUNDER)	$startTime 		= 	$_POST["startTimeHours"].":".$_POST["startTimeMinutes"].":01";		// LAGER STARTTID VARIABEL MED SEKUNDER (SATT TIL 01)	$endTime 		= 	$_POST["endTimeHours"].":".$_POST["endTimeMinutes"].":00";			// LAGER SLUTT-TUD VARIABEL MED SEKUNDER (SATT TIL 00)	$room			=	$_POST["name"];														// HENTER INN ROMMET FRA SKJEMAET	$userRef		=	$_SESSION["userRef"];												// HENTER USER-REF FRA SESSION OG LAGRER DET I ANGITT VARIABEL	$roomId 		= 	getRoomId($room);													// KALLER PÅ EN FUNKSJON FOR Å HENTE ROM ID	$ref_booking	=	$_POST['ref_booking'];												//HENTER REF-BOOKING FRA SKJEMAET	$bookedMinutesChange = $_POST['bookedMinutesChange'];									// HENTER HVOR MANGE MINUTTER OPPRINNELIG RESERVASJON HAR	if (!$startTime||!$endTime){															// SJEKKER OM STARTTID OG/ELLER SLUTT-TID IKKE ER BLITT SATT		print ("<h2>Alle feltene må fylles ut</h2>");										// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT (DVS. IKKE SATT)	} elseif($startTimeClean == $endTimeClean){												// SJEKKER OM STARTTID OG SLUTT-TID ER LIKE		print ("<h2>Starttid og slutttid kan ikke være like</h2>");							// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif($startTimeClean > $endTimeClean){												// SJEKKER OM STARTTID ER MINDRE ELLER LIK SLUTT-TID		print ("<h2>Slutttid kan ikke være tidligere enn starttid</h2>");					// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif($endTimeClean > '20:00'){														// SJEKKER OM SLUTTID ER STØRRE ENN KL. 20:00		print ("<h2>Rommet kan ikke bestilles for lengre enn til 20:00.</h2>");				// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif(checkIfRoomIsBooked($date, $startTime, $endTime, $roomId)) {					// KALLER PÅ FUNKSJON FOR Å SJEKKE OM ET ROM ER OPPTATT		print ("<h2>Dette rommet er bestilt innenfor den tidsrammen du har satt, vennligst prøv et annet</h2>");	// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif(checkUserLeftHours($userRef,$startTimeClean,$endTimeClean,$bookedMinutesChange)){					// KALLER PÅ FUNKSJON FOR Å SJEKKE OM EN BRUKER HAR NOK GJENVÆRENDE TIMER FOR Å BOOKE		print ("<script> alert('Din bestilling overstiger antall timer du totalt kan ha bestilling på')</script>");	// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} else {		connect();																			//KOBLER TIL DATABASEN		$sql="UPDATE Booking 				SET 				Start_Time='$startTime',				End_Time='$endTime'				WHERE Ref_booking='$ref_booking';";											//SQL-KOMMANDO SOM OPPDATERER DEN AKTUELLE BESTILLINGEN				$result=mysql_query($sql) or die("Ikke mulig å endre bestilling.");					//KJØRER SQL-KOMMANDO		disconnect();																		//KOBLER FRA DATABASEN			print ("<h2>Tidrommet for bestilling på rom $room er nå endret til " . normalTime($startTime) . "-" . normalTime($endTime) . ".</h2>");	//SKRIVER UT BEKREFTELSE PÅ HVA SOM ER BLITT REGISTRERT	echo ("		<form method='post' action='index.php'>		<input type='submit' value='Tilbake til forsiden' id='back' name='back'>		</form>		");																	//KNAPP SOM DIRIGERER TIL INDEX	}}?><?php include("../includes/footerNettsted.php");											//INKLUDERER FOOTER'EN TIL NETTSTEDET?>