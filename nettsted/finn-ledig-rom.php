<?php/** * Finn ledige rom på valgt tid * *Bruker legger inn ønsket dato og klokkeslett. *Får tilbake en liste over ledige rom dette tidsrommet  *den datoen. Hvert resultat har en "Bestill nå" knapp, *Og trykker brukeren på den, så bestilles rommet i det  *aktuelle tidsrommet og bekreftelsesmelding skrives ut. * * * * PHP version 5 * * LICENSE: This source file is subject to version 3.01 of the PHP license * that is available through the world-wide-web at the following URI: * http://www.php.net/license/3_01.txt.  If you did not receive a copy of * the PHP License and are unable to obtain it through the web, please * send a note to license@php.net so we can mail you a copy immediately. * * @author		Original Author <andersborglarsen@gmail.com> * @author		Original Author <haavard@ringshaug.net> * @author		Original Author <oyvind.gautestad@gmail.com> * @author		Original Author <linda.fermann@gmail.com> * @copyright 	2013-2018 * @license		http://www.php.net/license/3_01.txt * @link		http://student.hive.no/web10007/1 * */$title = 'Finn ledig rom';											//SETTER TITTEL PÅ SIDEN SOM HENTES AV HEADER OG PRINTES I FANE I BROWSERinclude("../includes/headerNettsted.php");							//INKLUDERER HEADER FOR NETTSTEDETcheckLogin();														//SJEKKER OM BRUKER ER LOGGET INN$userRef = $_SESSION['userRef'];									//SJEKKER BRUKERENS BRUKERREFERANSE OG TILORDNER I VARIABEL																	?><h2 class="marginTop40">Finn ledig rom</h2><fieldset>		<legend>Finn ledig rom</legend>		<p>Velg først ønsket måned og år, deretter tidsrom og velg hvilken type rom du vil bestille.</p><?php $selectDate = phpCalendar($userRef);		$selectDate = $_POST["selectDate"];?><form method="post" action="" name="findRooms" id="findRooms">			<p>Du har valgt dato: <?php echo normalDate($selectDate); ?>  </p>		<input type="hidden" name="date" id="date" value="<?php echo $selectDate; ?>" />				<label for="fraKl" class="clearfloat">Fra kl</label>		<select name="startTimeHours">		<?php 		$timer = array();																		// LAGER ET ARRAY FOR TIMER					connect();																				//KOBLER TIL DATABASEN		$sql="SELECT SUBSTRING(Klokka,1,2) as Timer FROM time GROUP BY Timer HAVING COUNT(*);";	// HENTER UT TIMER FRA DATABASEN		$result=mysql_query($sql) or die ("ikke mulig å hente timer fra databasen");			//KJØRER SPØRRINGEN MOT DATABASEN OG LAGRER RESULTATET I VARIABEL		$timerLength=mysql_num_rows($result);													// VARIABEL SOM SIER HVOR MANGE TIMER (RADER) ARRAYET ER		disconnect();																			// KOBLER FRA DATABASEN				for($i=0;$i<$timerLength;$i++) {														// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM TIMER TABELLEN HAR I LENGDE			$rad=mysql_fetch_array($result);													// LAGER VARIABEL $RAD SOM INNEHOLDER HELE ARRAYET			$timer[$i] = $rad[0];																// TILORDNER ALT FRA $RAD ARRAYET TIL TIME ARRAYET			echo "<option value='$rad[0]'>$rad[0]</option>";									// RETURNERER DEN SPESIFIKKE KOLONNEN FRA $RAD ARRAYET		}		?>		</select> 				<select name="startTimeMinutes">		<?php 		$minutter = array();																	// LAGER ET ARRAY FOR MINUTTER				connect();																				//KOBLER TIL DATABASEN		$sql="SELECT SUBSTRING(Klokka,4,2) as Minutter FROM time GROUP BY Minutter HAVING COUNT(*) > 1;";	// HENTER UT MINUTTER FRA DATABASEN		$result=mysql_query($sql) or die ("ikke mulig å hente minutter fra databasen");			//KJØRER SPØRRINGEN MOT DATABASEN OG LAGRER RESULTATET I VARIABEL		$minLength=mysql_num_rows($result);														// VARIABEL SOM SIER HVOR MANGE MINUTTER (RADER) ARRAYET ER		disconnect();																			//KOBLER FRA DATABASEN				for($i=0;$i<$minLength;$i++) {															// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM MINUTTER TABELLEN HAR I LENGDE			$rad=mysql_fetch_array($result);													// LAGER VARIABEL $RAD SOM INNEHOLDER HELE ARRAYET			$minutter[$i] = $rad[0];															// TILORDNER ALT FRA $RAD ARRAYET TIL MINUTT ARRAYET			echo "<option value='$rad[0]'>$rad[0]</option>";									// RETURNERER DEN SPESIFIKKE KOLONNEN FRA $RAD ARRAYET		}		?>		</select> 				<label for="tilKl" class="clearfloat">Til kl</label> 		<select name="endTimeHours">		<?php 		for($i=0;$i<$timerLength;$i++) {														// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM TIMETABELLEN ER I LENGDE			echo "<option value='$timer[$i]'>$timer[$i]</option>";								// RETURNERER DEN SPESIFIKKE KOLONNEN I TIMETABELLEN		}		?>		</select> 		<select name="endTimeMinutes">		<?php 		for($i=0;$i<$minLength;$i++) {															// FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM MINUTTTABELLEN ER I LENGDE			echo "<option value='$minutter[$i]'>$minutter[$i]</option>";						// RETURNERER DEN SPESIFIKKE KOLONNEN I MINUTT-TABELLEN		}		?>		</select> 				<label for="roomType" class="clearfloat">Romtype</label> 		<select name="roomType">			<?php 			$userRef = $_SESSION['userRef'];													// HENTER USER-REF FRA SESSION OG LAGRER DET I ANGITT VARIABEL			listRoomTypes($userRef);															//LISTER UT ROMTYPER AVHENGIG AV OM BRUKER ER ADMIN ELLER HVILKEN BRUKERGRUPPE BRUKEREN TILHØRER			?>		</select> 				<input type="submit" value="Søk" id="findRooms"			name="findRooms" tabindex="7" />	</fieldset></form><?php $findRooms = $_POST["findRooms"];															// LAGER FINN ROM-KNAPP					if($findRooms) {																			// LYTTER TIL OM KNAPPEN BLIR TRYKKET PÅ	$date			= 	$_POST["date"];														// HENTER INN DATO VARIABEL FRA SKJEMAET	$startTimeClean = 	$_POST["startTimeHours"].":".$_POST["startTimeMinutes"];			// HENTER INN CLEAN STARTTID FRA SKJEMAET(UTEN SEKUNDER)	$endTimeClean	=	$_POST["endTimeHours"].":".$_POST["endTimeMinutes"];				// HENTER INN CLEAN SLUTT-TID FRA SKJEMAET(UTEN SEKUNDER)	$startTime 		= 	$_POST["startTimeHours"].":".$_POST["startTimeMinutes"].":01";		// LAGER STARTTID VARIABEL MED SEKUNDER (SATT TIL 01)	$endTime 		= 	$_POST["endTimeHours"].":".$_POST["endTimeMinutes"].":00";			// LAGER SLUTT-TUD VARIABEL MED SEKUNDER (SATT TIL 00)	$userRef		=	$_SESSION["userRef"];												// HENTER USER-REF FRA SESSION OG LAGRER DET I ANGITT VARIABEL	$roomType		=	$_POST["roomType"];													// HENTER INN HVILKEN ROMTYPE ROMMET ER 		$bookedDateStartTime = $date . " " . $startTimeClean;									// SETTER SAMMEN DATO OG STARTTIDSPUNKT I EN VARIABEL (SKAL BRUKES I VALIDERING)	$today = date("Y-m-d H:i");																// HENTER GJELDENDE DATO OG TIDSPUNKT		if ( !$startTime|| !$endTime || !$date ){											// SJEKKER OM STARTTID OG/ELLER SLUTT-TID OG DATO IKKE ER BLITT SATT		print ("<script> alert('Dato må velges')</script>");												// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT (DVS. IKKE SATT)	} elseif($startTimeClean == $endTimeClean){												// SJEKKER OM STARTTID OG SLUTT-TID ER LIKE		print ("<script> alert('Starttid og sluttid kan ikke være like')</script>");							// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif($startTimeClean > $endTimeClean){												// SJEKKER OM STARTTID ER MINDRE ELLER LIK SLUTT-TID		print ("<script> alert('Sluttid kan ikke være tidligere enn starttid')</script>");					// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif($endTimeClean > '20:00'){														// SJEKKER OM SLUTTID ER STØRRE ENN KL. 20:00		print ("<script> alert('Rommet kan ikke bestilles for lengre enn til 20:00')</script>");				// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} elseif( $bookedDateStartTime < $today ){		print ("<script> alert('Du kan ikke reservere rom tidligere samme dag')</script>");	} elseif(checkUserLeftHours($userRef,$startTimeClean,$endTimeClean,$changeTime)){		// KALLER PÅ FUNKSJON FOR Å SJEKKE OM EN BRUKER HAR NOK GJENVÆRENDE TIMER FOR Å BOOKE		print ("<script> alert('Du har oversteget antall timer du kan reservere med ditt søk')</script>");						// RETURNERER FEILMELDING HVIS KRITERIET OVER ER SANT	} else {						connect();																			//KOBLER TIL DATABASEN			$sql = "SELECT RoomId,Name FROM Room WHERE Type='$roomType' ORDER BY Name ASC;";	//SQL-SPØRRING SOM SPØR OM ALLE ROM I VALGT ROMTYPE			$result = mysql_query($sql) or die("Ikke mulig å hente type romid fra databasen.");	//KJØRER SQL-SPØRRING OG TILORDNER I VARIABEL ELLER GIR FEILMELDING DERSOM NOE GÅR GALT			$numRows = mysql_num_rows($result);													//TELLER ANTALL RADER SPØRRINGEN GA, OG TILORDNER I VARIABEL		disconnect();																		//KOBLER FRA DATABASEN				echo '<h3>Følgende ' . $roomType . ' er ledige i tidspunktet du har valgt</h3>';		echo '<p>Trykk "Bestill nå" ved det rommet du ønsker å bestille</p>';		echo "<h4>Dato: $date</h4>";				for($t=1; $t<=$numRows; $t++){															//FOR LØKKE SOM GÅR LIKE MANGE GANGER SOM RADER RETURNERT I SQL-SPØRRING			$row=mysql_fetch_array($result);													// LAGER VARIABEL $ROW SOM INNEHOLDER HELE ARRAYET			$roomId=$row[0];																	//TILORDNER FØRSTE VERDI I RADEN TIL VARIABEL			$roomName=$row[1];																	//TILORDNER ANDRE VERDI I RADEN TIL VARIABEL						if (!checkIfRoomIsBooked($date, $startTime, $endTime, $roomId)) {					//SJEKKER OM HVERT ROM I AKTUELL TIDSPERIODE PÅ GITT DATO IKKE ER BOOKET. DERSOM IKKE BOOKET RETURNERES ROMMET SOM LEDIG I HTML-FORM				echo "<div>						<form action='' method='post' name='bookNowForm' id='bookNowForm'>						<strong>$roomName</strong>						<input type='submit' value='Bestill nå' name='bookNow' id='bookNow'>						<input type='hidden' value='$startTime' name='startTime' id='startTime'>						<input type='hidden' value='$endTime' name='endTime' id='endTime'>						<input type='hidden' value='$date' name='date' id='date'>						<input type='hidden' value='$roomId' name='roomId' id='roomId'>						<input type='hidden' value='$roomName' name='roomName' id='roomName'>						</form>					</div>";											}		}	}}$bookNow = $_POST["bookNow"];						//LAGER BESTILL-NÅ KNAAPPif ($bookNow) {										//LYTTER TIL OM KNAPP BLIR TRYKKET	$userRef		=	$_SESSION["userRef"];		//HENTER INN BRUKERREFERANSE FRA SKJEMA	$startTime 		= 	$_POST["startTime"];		//HENTER INN STARTTID FRA SKJEMA	$endTime 		= 	$_POST["endTime"];			//HENTER INN SLUTTID FRA SKJEMA	$date			= 	$_POST["date"];				//HENTER INN DATO FRA SKJEMA	$roomId			=	$_POST["roomId"];			//HENTER INN ROM-ID FRA SKJEMA	$bookingRef		=	createBookingRef();			//KALLER PÅ EN FUNKSJON FOR Å LAGE OG HENTE BOOKING-REF	$roomName		=	$_POST["roomName"];			//HENTER INN ROMNAVN FRA SKJEMA			connect();										//KOBLER TIL DATABASEN	$sql="INSERT INTO booking (	User_Ref,	Start_Time,	End_Time,	Dato,	Room_Id,	Ref_booking) VALUES (	'$userRef',	'$startTime',	'$endTime',	'$date',	'$roomId',	'$bookingRef')";								//SQL-KOMMANDO OM Å OPPRETTE BESTILLING I DATABASEN	$result=mysql_query($sql) or die("Ikke mulig å legge inn bestillingen din");	//KJØRER SQL-KOMMANDO OG BESTILLING OPPRETTES ELLER FEILMELDING RETURNERES DERSOM NOE GÅR GALT	disconnect();																	//KOBLER FRA DATABASEN	print ("<h3>Rom $roomName er nå bestilt den " . normalDate($date) . " mellom " . normalTime($startTime) . " og " . normalTime($endTime) . ".</h3>"); //SKRIVER UT BEKREFTELSE PÅ HVILKEN BESTILLING SOM ER GJORT}?><?php include("../includes/footerNettsted.php");	//INKLUDERER FOOTER FOR NETTSTED?>